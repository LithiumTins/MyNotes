# 6 - 整数集合
整数集合是集合的底层实现之一，当集合只包含整数且元素竖向不多时，Redis 就会使用整数集合来实现集合。如：
```shell
# 创建一个小集合，全部由整数组成
redis> SADD integers 1 2 3 4 5
(integer) 5

# 查看集合的底层实现
redis> OBJECT ENCODING numbers
"intset"
```

## 整数集合的实现
整数集合可以保存类型为 int16_t、int32_t、int64_t 的整数值，并且保证集合中不会出现重复元素。

整数集合用 intset.h/intset 结构体表示，它的定义如下：
```c
typedef struct intset {
    // 编码方式
    uint32_t encoding;

    // 集合包含的元素数量
    uint32_t length;

    // 保存元素的数组
    int8_t contents[];
} intset;
```
`contents` 数组是整数集合的底层实现，整数集合的每个元素都是一个数组项，各个项在数组中按照从小到大的顺序排列，其中没有重复元素。`length` 记录了整数集合包含的元素数量，即 `contents` 数组的长度。

虽然 `contents` 数组声明为 `int8_t` 类型，实际上它的真正类型由 `encoding` 属性决定：
- `INTSET_ENC_INT16`：类型为 `int16_t`，每个项都是一个 16 位有符号整数
- `INTSET_ENC_INT32`：类型为 `int32_t`
- `INTSET_ENC_INT64`：类型为 `int64_t`

因此，整个整数集合的编码方式都是统一的，只有有一个元素需要非常大的类型，其他的元素也会使用这个类型。

## 升级
如果插入一个新元素，并且它需要的类型比整数集合现有的类型要大，那么整数集合会进行升级。升级的步骤如下：
1. 扩展存储空间，同时为新元素分配空间
1. 把原有的元素转换成新的类型，放到正确的位置
1. 插入新元素到末尾（显然它会比所有的元素都大）

## 升级的好处

### 提升灵活性
可以随意添加不同类型的整数，整数集合会处理好类型问题。

### 节约内存
当存入集合的整数比较小时，不需要使用大的类型，节约了内存。

## 降级
整数集合不支持降级操作，一旦升级就不会再降级，即使引起升级的元素被删除了。

## 整数集合API
| 函数 | 作用 | 时间复杂度 |
| --- | --- | --- |
| intsetNew | 创建一个新的压缩列表 | O(1) |
| intsetAdd | 向整数集合中添加一个元素 | O(N) |
| intsetRemove | 从整数集合中删除一个元素 | O(N) |
| intsetFind | 检查给定值是否存在于集合 | O(logN) |
| intsetRandom | 从整数集合中随机返回一个元素 | O(1) |
| intsetGet | 获取底层数组中给定索引位置的元素 | O(1) |
| intsetLen | 获取整数集合的元素数量 | O(1) |
| intsetBlobLen | 获取整数集合占用的内存字节数 | O(1) |